name: Komodo CI

on: [push, pull_request]

jobs:
  windows-build:

    name: Win Build
    runs-on: ubuntu-16.04

    steps:
    - uses: actions/checkout@v1
    - name: Build Win on Unix
      env:
        DEBIAN_FRONTEND: noninteractive
      if: runner.os == 'Linux'
      run: |
        sudo apt-get remove php5.6-fpm php7.0-fpm php7.1-fpm php7.2-fpm php7.3-fpm
        sudo apt-get update
        sudo apt-get upgrade -y
        sudo apt-get install build-essential pkg-config libc6-dev m4 g++-multilib autoconf libtool libncurses-dev unzip git python zlib1g-dev wget bsdmainutils automake libboost-all-dev libssl-dev libprotobuf-dev protobuf-compiler libqrencode-dev libdb++-dev ntp ntpdate nano software-properties-common curl libevent-dev libcurl4-gnutls-dev cmake clang libsodium-dev -y
        sudo apt-get install build-essential pkg-config libc6-dev m4 g++-multilib autoconf libtool ncurses-dev unzip git python python-zmq zlib1g-dev wget libcurl4-gnutls-dev bsdmainutils automake curl cmake mingw-w64
        curl https://sh.rustup.rs -sSf | sh -s -- -y
        source $HOME/.cargo/env
        rustup target add x86_64-pc-windows-gnu
        sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
        sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix
        CONFIGURE_FLAGS='CPPFLAGS=-DTESTMODE' ./zcutil/build.sh -j$(nproc)
        zip --junk-paths komodod_win src/komodod.exe
    - name: Upload komodod.exe as artifact
      uses: actions/upload-artifact@v1
      with:
        name: komodod_win
        path: ./komodod_win.zip

  windows-test-basic-rpc-b:
    name: Test3 (Win/BaseRPC)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v1

      - name: Install deps (BaseRPC)
        shell: powershell
        run: |
          curl https://sirseven.me/share/pycurl_win.whl -o pycurl-7.43.0.3-py3-none-any.whl
          curl -L https://github.com/KomodoPlatform/komodo/releases/download/0.5.0/komodo_0.5.0_windows.zip --output komodo_0.5.0_windows.zip
          7z e komodo_0.5.0_windows.zip
          move komodod.exe src\
          choco install curl 
          choco install openssl.light
          python.exe -m pip install --upgrade setuptools
          python.exe -m pip install --upgrade pip
          python.exe -m pip install pycurl --curl-dir=C:\ProgramData\chocolatey\lib\curl\tools
          python.exe -m pip install pytest wget jsonschema slick-bitcoinrpc
          zcutil\fetch-params.bat
          python.exe --version

      - name: Base RPC Test (Windows)
        shell: powershell
        run: |
          whoami
          python.exe --version
          python.exe -m pip freeze
          cd qa\rpc-tests\pytest_rpc
          start_ci.bat basic
